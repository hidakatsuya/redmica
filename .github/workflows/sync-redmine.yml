name: Sync to Redmine

on:
  push:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  open-pr-to-sync:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          path: redmica

      - uses: actions/checkout@v4
        with:
          repository: "redmine/redmine"
          fetch-depth: 0
          path: redmine

      - run: echo "REDMINE_COMMIT_ID=$(cat .github/REDMINE_COMMIT_ID)" >> $GITHUB_ENV
        working-directory: redmica

      - run: echo "REDMINE_LATEST_COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV
        working-directory: redmine

      - run: |
          git filter-branch --msg-filter 'sed -e "s/\([[:punct:][:space:]]\)#\([0-9]*\)\([[:punct:][:space:]]\)/\1redmine-\2\3/g"' -f $REDMINE_COMMIT_ID..HEAD
          git log --oneline $REDMINE_COMMIT_ID..HEAD
          git format-patch $REDMINE_COMMIT_ID
        working-directory: redmine
        env:
          FILTER_BRANCH_SQUELCH_WARNING: 1

      - run: |
          git config --global user.email "$GIT_USER_EMAIL"
          git config --global user.name "$GIT_USER_NAME"
        env:
          GIT_USER_NAME: github-actions[bot]
          GIT_USER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com

      - run: |
          git switch -c sync-to-redmine/$REDMINE_LATEST_COMMIT_ID
          git am $GITHUB_WORKSPACE/redmine/*.patch

          echo $REDMINE_LATEST_COMMIT_ID
          ls -al .github
          cat .github/REDMINE_COMMIT_ID

          echo "$REDMINE_LATEST_COMMIT_ID" > .github/REDMINE_COMMIT_ID

          git commit -m "Synced to redmine/redmine@$REDMINE_LATEST_COMMIT_ID" .github/REDMINE_COMMIT_ID

          git log --oneline -n 50

          git push origin sync-to-redmine/$REDMINE_LATEST_COMMIT_ID

          gh pr create --base master --head sync-to-redmine/$REDMINE_LATEST_COMMIT_ID --title "Sync to Redmine $REDMINE_LATEST_COMMIT_ID" --body "Sync to Redmine $REDMINE_LATEST_COMMIT_ID"
        working-directory: redmica
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
